## 概念

### 网络层

IP 地址 掩码和网络号 默认网关 ARP 表 路由表 三层接口 IP 和 ARP 报文基本结构



### 数据链路层

MAC地址 广播域 VLAN **FDB 表** 二层接口 以太网帧结构



## 行为

### 网络层

添加路由表

ARP 打通

路由查找



## 数据链路层

VLAN 分配

VLAN 过滤

VLAN tag 决策

源MAC地址学习

FDB表项老化

目的MAC地址查找转发

VLAN内泛洪





## 接口基础配置

### 网络层接口：

1. SVI 口
   1. 创建 VLAN
   2. 创建 SVI 口，注意 SVI 口的编号与对应 VLAN 相同
   3. 配置 SVI 口的 IP 地址
2. 路由口
   1. 创建路由口，路由口编号与物理口编号形同
   2. 配置路由口的 IP 地址



### 数据链路层接口：

1. trunk 口
   1. 配置接口为 TRUNK 口
   2. 配置接口的 native vlan
   3. 配置接口的 VLAN 允许列表
2. access 口
   1. 配置接口模式为 ACCESS 口
   2. 配置接口所属 VLAN



## 1. OSI 模型

……





## 2. TCP/IP 模型

### 1. 物理层

定义接口与线缆

双绞线、光纤、RJ-45、V24 V35 G.703



### 2. 数据链路层

物理介质访问

Ethernet、PPP、HDLC、Frame Relay



### 3. 网络层

寻址和路由选择

IP（ICMP、ARP）



### 4. 传输层

建立端到端连接

TCP、UDP



### 5. 应用层

提供应用程序与网络的接口

HTTP、FTP、SMTP、DNS





## 3. 网络设备

|   应用层   |                    |
| :--------: | :----------------: |
|   传输层   |       防火墙       |
|   网络层   | 三层交换机、路由器 |
| 数据链路层 |     二层交换机     |
|   物理层   |    中继器、HUB     |



## 4. 寻址与地址映射

### 地址用于标识设备或接口





# 以太网基础



## 1. MAC 地址（48bit）



### 1. OUI（24bit）

网络硬件制造商编号

第一位（I/G）表示此 MAC 地址是单播还是组播地址，如果第一位位（LSB） = 0，单播；LSB = 1， 组播。

第二位（U/G）表示此 MAC 地址由 IEEE 维护的全局地址还是局域性地址， = 0 是全局性， = 1 是局域性维护地址。



### 2. address（24bit）

网卡等系列号。



### 3. MAC 地址类型

| 广播地址 | FFFF : FFFF : FFFF |
| :------: | :----------------: |
| 组播地址 | 0100 : 5E01 : 0101 |
| 单播地址 | 00D0 : 0011 : 2233 |

 在数据帧中，目的 MAC 地址可以为以上三种，但源 MAC 地址只能为单播地址，如源 MAC 地址不是单播地址就**丢弃**。



### 4. 以太网帧结构

#### Ethernet II/802.3

| preamble | SFD  | DMAC | SMAC | Type/Length | Playload | FCS  |
| :------: | :--: | :--: | :--: | :---------: | :------: | :--: |
|    7     |  1   |  6   |  6   |      2      | 46-1500  |  4   |



###### $\color{red}{！！！ 注意 ！！！}$

##### 1. preamble 前导码

实际上前导码都是在**物理层**上加入，并不是帧的 一部分。

##### 2. Type/Length

|      Type       |     Length      |
| :-------------: | :-------------: |
| 0x0600 ~ 0xFFFF | 0x0000 ~ 0x05DC |

##### 3. PayLoad

最小为 46 B，最大为 1500 B。

对于 Type 字段，上层协议必须保证此字段值大于 46 B；

对于Length字段，不足 46 B 必须填充。 

**$\color{red}{！！！ 注意 ！！！}$**





# VLAN

一个 VLAN 组成一个逻辑子网/逻辑广播域。

工作在 OSI 参考模型的第 2、3 层。

VLAN 之间的通讯是由第 3 层路由完成。 

IEEE 标准为 802.1Q。



## 1. VLAN 的帧结构

### IEEE 802.1Q

#### Ethernet Version 2

| DMAC | SMAC | type |  length   | CRC  |
| :--: | :--: | :--: | :-------: | :--: |
| 6 B  | 6 B  | 2 B  | 46~1500 B | 4 B  |



#### IEEE 802.1Q

| DMAC | SMAC |  TPID  | Tag  | type |  length   | CRC  |
| :--: | :--: | :----: | :--: | :--: | :-------: | :--: |
| 6 B  | 6 B  | 0x8100 | 4 B  | 2 B  | 46~1500 B | 4 B  |

#### Tag

| user priority |  CFI  | VLAN ID |
| :-----------: | :---: | :-----: |
|     3 bit     | 1 bit | 12 bit  |



## 2. VLAN 作用

控制网络的广播风暴

安全

简化网络管理



## 3. VLAN 的原理



### 1. 基于端口划分

根据交换机的接口分配 VLAN ID，若进入交换的报文本身携带有 VLAN TAG，则以 TAG 内的 VLAN ID为准。

优点：划分简单

缺点：某个用户的端口连接到新端口后，需要重新定义。



### 2. 输入规则检查

配置 VLAN 成员表，指明此端口是否在同一个 VLAN 中。

检查即交换机接收到一个数据报文的时候，需要判断端口是否在接收到的报文所划分的 VLAN 中，如不在，则丢弃。

**检查过程：**

如果 VID = 0xFFF，报文将丢弃。

帧的 VID 属性是否与设置一致，如果端口只接收含有 VLAN-TAG 的帧，则 VID = 0x0 的报文则丢弃。

能检查 VLAN 的情况下，端口不在所收到的帧的 VID 对应的 VLAN 中，则丢弃。



### 3. 输出规则检查

**检查过程：**

输出端口不在帧 VID 对应的 VLAN 中，丢弃。

如果端口要求输出 UNTAG 帧，但 TAG 中的 CFI  = 1，丢弃。

当报文通过输出规则检查确定可以在此端口输出时，还需确定是 tag 输出还是 untagged 输出，即输出报文是否带有 802.1Q tag，此规则也是由用户指定。当确定输出报文为 tag 报文时， 其 tag 中的 VID 时此报文所划分的 VLAN ID。



## 4. VLAN 端口类型

### 1. PVID

Port VLAN ID, 指端口的缺省 VLAN ID。

### 2. VLAN ID

有效范围：1 ~ 4094，0 和 4095 都是协议保留值。

0 ： 不属于任何 VLAN， 但携带 802.1Q 的优先级标签。一般作为系统使用，用户不可使用和删除。

1 ： 系统默认 VLAN。

2 ~ 1001 ： 普通 VLAN。

1002 ~ 1005 ： 支持 FDDI 和令牌环的 VLAN。

1006 ~ 1024 ： 仅系统使用，用户不能查看和使用。

1025 ~ 4095 ： 是扩展 VLAN。



### 3. tag、untag

tag 是指以太网数据帧中携带 4 B 802.1Q  信息的 VLAN 标签，其中 VLAN ID，用来指名数据包属于哪个 VLAN。

untag 指数据包不属于任何 VLAN。





ACCESS端口：

只能属于 1 个 VLAN，一般用于连接计算机的端口。

Trunk端口：

可以同时传送多个 VLAN 的包，一般用于交换机之间的连接。

缺省 VLAN：

ACCESS 端口所在的 VLAN 即是缺省 VLAN。

Trunk 端口缺省 VLAN 为 VLAN 1。	





## 5. 过滤地址

源 MAC 或目的 MAC 地址为过滤地址的报文，丢弃。

