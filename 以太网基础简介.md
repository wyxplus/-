## 一. 概念

#### 1. 网络层

IP 地址 掩码和网络号 默认网关 ARP 表 路由表 三层接口 IP 和 ARP 报文基本结构



#### 2. 数据链路层

MAC地址 广播域 VLAN **FDB 表** 二层接口 以太网帧结构



## 二. 行为



#### 1. 网络层

添加路由表

ARP 打通

路由查找



### 2. 数据链路层

VLAN 分配

VLAN 过滤

VLAN tag 决策

源MAC地址学习

FDB表项老化

目的MAC地址查找转发

VLAN内泛洪





## 三. 接口基础配置

#### 1. 网络层接口：

1. SVI 口
   1. 创建 VLAN
   2. 创建 SVI 口，注意 SVI 口的编号与对应 VLAN 相同
   3. 配置 SVI 口的 IP 地址
2. 路由口
   1. 创建路由口，路由口编号与物理口编号形同
   2. 配置路由口的 IP 地址



#### 2. 数据链路层接口：

1. trunk 口
   1. 配置接口为 TRUNK 口
   2. 配置接口的 native vlan
   3. 配置接口的 VLAN 允许列表
2. access 口
   1. 配置接口模式为 ACCESS 口
   2. 配置接口所属 VLAN



## 四. OSI 模型

……





## 五. TCP/IP 模型

|               |                                                    |
| :-----------: | :------------------------------------------------: |
|   1. 物理层   | 定义接口与线缆。双绞线、光纤、RJ-45、V24 V35 G.703 |
| 2. 数据链路层 |   物理介质访问。Ethernet、PPP、HDLC、Frame Relay   |
|   3. 网络层   |          寻址和路由选择。IP（ICMP、ARP）           |
|   4. 传输层   |              建立端到端连接。TCP、UDP              |
|   5. 应用层   |   提供应用程序与网络的接口。HTTP、FTP、SMTP、DNS   |



## 六. 网络设备

|            |                    |
| :--------: | :----------------: |
|   应用层   |         无         |
|   传输层   |       防火墙       |
|   网络层   | 三层交换机、路由器 |
| 数据链路层 |     二层交换机     |
|   物理层   |    中继器、HUB     |



## 七. 寻址与地址映射

#### 地址用于标识设备或接口





# 以太网基础



## 一. MAC 地址（48bit）



### 1. OUI（24bit）

网络硬件制造商编号。

第一位（I/G）表示此 MAC 地址是单播还是组播地址，如果第一位（LSB） = 0，单播；LSB = 1， 组播。

第二位（G/L）表示此 MAC 地址由 IEEE 维护的全局地址还是局域性地址， = 0 是全局性， = 1 是局域性维护地址。



### 2. address（24bit）

网卡等系列号。



### 3. MAC 地址类型

|          |                    |
| :------: | :----------------: |
| 广播地址 | FFFF : FFFF : FFFF |
| 组播地址 | 0100 : 5E01 : 0101 |
| 单播地址 | 00D0 : 0011 : 2233 |

 在数据帧中，目的 MAC 地址可以为以上三种，但源 MAC 地址只能为==**单播地址**==，如源 MAC 地址不是单播地址就**==丢弃==**。



### 4. 以太网帧结构

#### Ethernet II/802.3

| preamble | SFD  | DMAC | SMAC | Type/Length | Playload  | FCS  |
| :------: | :--: | :--: | :--: | :---------: | :-------: | :--: |
|   7 B    | 1 B  | 6 B  | 6 B  |     2 B     | 46-1500 B | 4 B  |



##### （1）. preamble 前导码、SFD 帧开始符

​		实际上前导码、帧开始符都是在**==物理层==**上加入，并不是帧的一部分。		

##### （2）. Type/Length	

|      Type       |     Length      |
| :-------------: | :-------------: |
| 0x0600 ~ 0xFFFF | 0x0000 ~ 0x05DC |

##### （3）. PayLoad

​		**最小**为 46 B，**最大**为 1500 B。

​		对于 Type 字段，上层协议必须保证此字段值大于 46 B；

​		对于Length字段，不足 46 B 必须填充。 

##### （4）. FCS 帧检验序列

​		使用CRC检验。





## 二. VLAN



​		一个 VLAN 组成一个逻辑子网/逻辑广播域。

​		工作在 OSI 参考模型的第 2、3 层。

​		VLAN 之间的**通讯**是由第 3 层路由完成。 

​		IEEE 标准为 802.1Q。



### 1. VLAN 的帧结构



#### Ethernet Version 2

| DMAC | SMAC | type |  length   | CRC  |
| :--: | :--: | :--: | :-------: | :--: |
| 6 B  | 6 B  | 2 B  | 46~1500 B | 4 B  |



#### IEEE 802.1Q

| DMAC | SMAC |      TPID      | Tag（TCI） | type |  length   | CRC  |
| :--: | :--: | :------------: | :--------: | :--: | :-------: | :--: |
| 6 B  | 6 B  | 2 B （0x8100） |    2 B     | 2 B  | 46~1500 B | 4 B  |



#### Tag（TCI）

| user priority |  CFI  | VLAN ID |
| :-----------: | :---: | :-----: |
|     3 bit     | 1 bit | 12 bit  |



### 2. VLAN 作用

​		控制网络的广播风暴。

​		安全。

​		简化网络管理。



### 3. VLAN 的原理

#### （1）. 基于端口划分

​		根据交换机的接口分配 VLAN ID（VID），若进入交换的报文本身携带有 VLAN TAG，则以 TAG 内的 VLAN ID为准。

​		优点：划分简单。

​		缺点：某个用户的端口连接到新端口后，需要重新定义。



#### （2）. ==输入==规则检查



| 端口类型 |          不带 Tag          |                            带 Tag                            |
| :------: | :------------------------: | :----------------------------------------------------------: |
|  Access  | **接收**，并把报文添加 Tag | Tag 中 VID == 缺省 VID：**接收** <br/>Tag 中 VID ！= 缺省 VID：**丢弃** |
|  Trunk   | **接收**，并把报文添加 Tag | Tag 中 VID == 缺省 VID ：**接收**<br/>Tag 中 VID ！= 缺省 VID，Tag 中 VID 是允许通过：**接收**<br/>Tag 中 VID ！= 缺省 VID，Tag 中 VID 是不允许通过：**接收** |

​		配置 VLAN 成员表，指明此端口是否在同一个 VLAN 中。

​		检查即交换机接收到一个数据帧的时候，需要判断端口是否在接收到的帧所划分的 VLAN 中，如不在，则丢弃。

​		**检查过程：**

​				如果 VID = 0xFFF，报文将丢弃。

​				帧的 VID 属性是否与设置一致，如果端口只接收含有 VLAN-TAG 的帧，则 VID = 0x0 的报文则丢弃。

​				能检查 VLAN 的情况下，端口不在所收到的帧的 VID 对应的 VLAN 中，则丢弃。



#### （3）. ==输出==规则检查

| 端口类型 |                             处理                             |
| :------: | :----------------------------------------------------------: |
|  Access  |        Tag VLAN ID == 缺省 VLAN ID：**去掉 Tag 发送**        |
|  Trunk   | Tag VID == 缺省 VID：**去掉 Tag 发送**<br />Tag VID != 缺省 VID：**保持原有 Tag 发送** |

​		**检查过程：**

​				输出端口不在帧 VID 对应的 VLAN 中，丢弃。

​				如果端口要求输出 UNTAG 帧，但 TAG 中的 CFI  = 1，丢弃。

​				当报文通过输出规则检查确定可以在此端口输出时，还需确定是 tag 输出还是 untagged 输出，即输出		报文是否带有 802.1Q tag，此规则也是由用户指定。当确定输出报文为 tag 报文时， 其 tag 中的 VID 时此报		文所划分的 VLAN ID。



### 4. VLAN 端口类型

#### （1）. PVID

​		Port VLAN ID, 指端口的缺省 VLAN ID（native VLAN）。



#### （2）. VLAN ID

​		有效范围：1 ~ 4094，0 和 4095 都是协议保留值。

​		0 ： 不属于任何 VLAN， 但携带 802.1Q 的优先级标签。一般作为系统使用，用户不可使用和删除。

​		1 ： 系统默认 VLAN。

​		2 ~ 1001 ： 普通 VLAN。

​		1002 ~ 1005 ： 支持 FDDI 和令牌环的 VLAN。

​		1006 ~ 1024 ： 仅系统使用，用户不能查看和使用。

​		1025 ~ 4095 ： 是扩展 VLAN。



#### （3）. tag、untag

​		tag 是指以太网数据帧中携带 4 B 802.1Q  信息的 VLAN 标签，其中 VLAN ID，用来指名数据包属于哪个 VLAN。

​		untag 指数据包不属于任何 VLAN。



#### （4）.  交换机端口

​		**Access端口（访问链接）：**

​				只能属于 1 个 VLAN，一般用于连接计算机的端口。

​				通常设置 VLAN 顺序是：

​					1. 生成 VLAN

​					2. 设定访问链接（决定各个端口属于哪个 VLAN）



​		**Trunk端口（汇聚链接）：**

​				可以同时传送多个 VLAN 的包，一般用于交换机之间的连接。

​				汇聚链接传输数据流程：

​						VLAN 1 中的 PC 1 想要与 VLAN 2 中的 PC 3 通信。

​						a. PC 1 发送的数据帧从交换机 1 的Trunk 口到达交换机 2 的 Trunk 口时，在数据帧上**==附加了 VLAN ID = 1 的 tag==**。

​						b. 交换机 2 收到数据帧后，经过检查发现 tag 是属于 VLAN 1。

​						c. 因此，**==去除 tag==** 后将复原的数据帧广播给 VLAN 1 的所有成员（广播帧、多播帧或目标不明确的帧）。



​		**缺省 VLAN：**

​					ACCESS 端口所在的 VLAN 即是缺省 VLAN。

​					Trunk 端口缺省 VLAN 为 VLAN 1。	



### 5. 静态 VLAN 和动态 VLAN

|                种类                |                  解说                   |
| :--------------------------------: | :-------------------------------------: |
|   ==**静态**==：基于端口的 VLAN    | 将交换机的各端口**==固定==**指派给 VLAN |
| ==**动态**==：基于 MAC 地址的 VLAN | 根据各端口所连计算机的 **MAC 地址**设定 |
|   ==**动态**==：基于子网的 VLAN    | 根据各端口所连计算机的 **IP 地址**设定  |
|   ==**动态**==：基于用户的 VLAN    | 根据各端口所连计算机的**用户登录**设定  |



### 6. 过滤地址

源 MAC 或目的 MAC 地址为过滤地址的报文，丢弃。

